<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel</title>
<style>
  :root { --bg-main: #0f1724; --bg-section: #0b1220; --border-color: #1f2937; --text-main: #e6eef8; --text-muted: #9fb3d9; --green: #16a34a; --red: #dc2626; --blue: #2563eb; --yellow: #f59e0b; --purple: #4f46e5; }
  body{margin:0;padding:20px;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg-main);color:var(--text-main); display: flex; align-items: center; justify-content: center; min-height: 100vh;}
  .container{max-width:1300px;margin:0 auto; width: 100%;}
  h1,h2{margin:0 0 12px 0; text-align: center;}
  .section{background:var(--bg-section);border:1px solid var(--border-color);border-radius:10px;padding:12px;margin-bottom:16px;}
  table{width:100%;border-collapse:collapse;margin-top:8px;}
  th,td{padding:8px 10px;border:1px solid rgba(255,255,255,0.06);text-align:center;font-size:14px; word-break: break-word; vertical-align: middle;}
  th{background:rgba(255,255,255,0.03);}
  .no-data{opacity:0.7;text-align:center;padding:18px;color:var(--text-muted);}
  .btn { 
    padding: 6px 12px; 
    border-radius: 6px; 
    border: 1px solid var(--border-color); 
    cursor: pointer; 
    color: var(--text-main); 
    font-size: 0.8rem; 
    font-weight: 500;
    margin: 2px; 
    background-color: #1f2937;
    transition: background-color 0.2s ease, filter 0.2s ease;
  }
  .btn:hover { filter: brightness(1.2); }
  .btn-green { background-color: #15803d; border-color: #16a34a; } .btn-green:hover { background-color: #16a34a; }
  .btn-red { background-color: #b91c1c; border-color: #dc2626; } .btn-red:hover { background-color: #dc2626; }
  .btn-blue { background-color: #1d4ed8; border-color: #2563eb; } .btn-blue:hover { background-color: #2563eb; }
  .btn-dark-red { background: #7f1d1d; border-color: #991b1b; } .btn-dark-red:hover { background-color: #991b1b; }
  .btn-purple { background: #4338ca; border-color: #4f46e5; } .btn-purple:hover { background-color: #4f46e5; }
  .status { font-weight: bold; padding: 4px 8px; border-radius: 6px; color: white; }
  .status-pending { background-color: var(--yellow); } .status-approved { background-color: var(--green); } .status-rejected { background-color: var(--red); }
  .actions-cell { display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap; }
  .balance-input { width: 80px; padding: 4px; border-radius: 4px; border: 1px solid #334155; background: #1e293b; color: var(--text-main); }
  #support-center { display: flex; gap: 16px; min-height: 60vh; max-height: 70vh; }
  #chat-list-container { flex: 0 0 300px; background: rgba(0,0,0,0.1); border-radius: 8px; overflow-y: auto; padding: 8px; }
  .chat-list-item { padding: 12px; border-radius: 6px; cursor: pointer; margin-bottom: 6px; border: 1px solid transparent; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; }
  .chat-list-item:hover { background: rgba(255,255,255,0.05); border-color: var(--border-color); }
  .chat-list-item.active { background: var(--blue); color: white; }
  .new-message-indicator { width: 10px; height: 10px; background-color: var(--green); border-radius: 50%; }
  #chat-view-container { flex-grow: 1; border-radius: 8px; background: rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
  #chat-view-header { padding: 12px; background: rgba(0,0,0,0.2); font-weight: bold; text-align: center; border-bottom: 1px solid var(--border-color); }
  #messages-container { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
  .message { max-width: 70%; padding: 8px 12px; border-radius: 10px; line-height: 1.4; word-break: break-word; }
  .message.user { background: #374151; color: white; align-self: flex-start; }
  .message.admin { background: var(--purple); color: white; align-self: flex-end; }
  #reply-area { display: flex; padding: 10px; border-top: 1px solid var(--border-color); }
  #reply-input { flex-grow: 1; background: #1e293b; border: 1px solid #334155; border-radius: 6px; padding: 8px; color: white; }
  #send-reply-btn { background: var(--purple); color: white; border: none; padding: 0 16px; border-radius: 6px; margin-left: 8px; cursor: pointer; font-weight: bold; }
  #chat-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); }
  #userSearchInput { width: 100%; padding: 8px 12px; margin-bottom: 12px; background-color: #1e293b; border: 1px solid #334155; border-radius: 6px; color: var(--text-main); font-size: 1rem; box-sizing: border-box; }
  #dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
  .stat-card { background: var(--bg-section); border: 1px solid var(--border-color); border-radius: 10px; padding: 16px; text-align: center; }
  .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 4px; color: var(--text-main); }
  .stat-label { font-size: 0.9rem; color: var(--text-muted); }
  #announcement-textarea { width: 100%; box-sizing: border-box; background: #1e293b; border: 1px solid #334155; color: var(--text-main); padding: 10px; border-radius: 6px; min-height: 80px; margin-bottom: 10px; }
  #past-announcements-list { max-height: 200px; overflow-y: auto; margin-top: 12px; }
  .past-announcement-item { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-start; }
  .past-announcement-item p { margin: 0; white-space: pre-wrap; word-break: break-word; }
  .past-announcement-item .meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 6px; }
  #statusForm { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
  #statusForm .full-width { grid-column: 1 / -1; }
  #statusForm label { font-size: 0.9rem; margin-bottom: 5px; display: block; color: var(--text-muted); }
  #statusForm input, #statusForm select, #statusForm textarea { width: 100%; box-sizing: border-box; background-color: #1e293b; border: 1px solid #334155; border-radius: 6px; color: var(--text-main); font-size: 1rem; padding: 8px; }
  .form-buttons { grid-column: 1 / -1; display: flex; gap: 10px; justify-content: flex-end; }
  #moneyRainControls { display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
  .rain-input-group { display: flex; flex-direction: column; gap: 5px; }
  .rain-input-group label { font-size: 0.85rem; color: var(--text-muted); }
  .rain-input-group input { background-color: #1e293b; border: 1px solid #334155; border-radius: 6px; color: var(--text-main); font-size: 1rem; padding: 8px; max-width: 120px; }
  .status-display { padding: 8px 12px; border-radius: 6px; font-weight: bold; text-align: center; }
  .status-display.idle { background: #4b5563; }
  .status-display.pending { background: var(--yellow); color: var(--bg-main); }
  .status-display.active { background: var(--green); }
  @media screen and (max-width: 768px) {
    body { padding: 10px; }
    #support-center, #statusForm { flex-direction: column; display: flex; }
    #chat-list-container { flex-basis: 200px; }
    table, thead, tbody, th, td, tr { display: block; }
    thead tr { position: absolute; top: -9999px; left: -9999px; }
    tr { margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    td { border: none; border-bottom: 1px solid rgba(255,255,255,0.06); position: relative; padding-left: 50%; text-align: right; min-height: 30px; display: flex; align-items: center; justify-content: flex-end; }
    td:last-child { border-bottom: 0; }
    td:before { content: attr(data-label); position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; opacity: 0.8; }
    .actions-cell { flex-direction: column; align-items: stretch; padding: 10px; gap: 8px; }
    .balance-input, .btn { width: 100%; box-sizing: border-box; padding: 8px; margin: 0; }
    #statusForm { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="container">
    <div id="main-content">
      <h1 id="admin-welcome">Admin Panel</h1>
      <div id="dashboard-grid" class="section">
        <div class="stat-card"><div class="stat-value" id="stat-total-users">0</div><div class="stat-label">Ümumi İstifadəçi</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-total-balance">0.00</div><div class="stat-label">Sistemdəki Balans (AZN)</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-pending-reqs">0</div><div class="stat-label">Gözləyən Sorğu</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-pending-amount">0.00</div><div class="stat-label">Gözləyən Məbləğ (AZN)</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-unread-msgs">0</div><div class="stat-label">Oxunmamış Mesaj</div></div>
      </div>
      <div class="section">
        <h2 style="margin:0;">Para Yağışı İdarəetməsi</h2>
        <div id="moneyRainControls">
            <div class="rain-input-group">
                <label for="moneyRainAmount">Paylanacaq Məbləğ (AZN)</label>
                <input type="number" id="moneyRainAmount" placeholder="Məs: 1.50" value="1">
            </div>
            <div class="rain-input-group">
                <label for="moneyRainDuration">Oyun Müddəti (san)</label>
                <input type="number" id="moneyRainDuration" placeholder="Məs: 30" value="30">
            </div>
            <div class="rain-input-group">
                <label>Vəziyyət</label>
                <div id="moneyRainStatus" class="status-display idle">Boş</div>
            </div>
            <button id="startMoneyRainBtn" class="btn btn-green">Yağışı Başlat</button>
            <button id="stopMoneyRainBtn" class="btn btn-red">Dayandır</button>
        </div>
      </div>
            <div class="section">
        <h2 style="margin:0;">Sistem Vəziyyətini İdarə Et</h2>
        <table id="statusManagementTable">
            <thead><tr><th>Sıra</th><th>Başlıq</th><th>Açıqlama</th><th>Vəziyyət</th><th>Əməliyyatlar</th></tr></thead>
            <tbody><tr class="no-data-row"><td colspan="5" class="no-data">Status yoxdur.</td></tr></tbody>
        </table>
        <form id="statusForm">
            <input type="hidden" id="statusKey">
            <div class="full-width">
                <label for="statusLabel">Başlıq</label>
                <input type="text" id="statusLabel" required>
            </div>
            <div class="full-width">
                <label for="statusText">Açıqlama</label>
                <textarea id="statusText" rows="2" required></textarea>
            </div>
            <div>
                <label for="statusOrder">Sıra</label>
                <input type="number" id="statusOrder" value="1" required>
            </div>
            <div>
                <label for="statusState">Vəziyyət</label>
                <select id="statusState" required>
                    <option value="active">Aktiv (Yaşıl)</option>
                    <option value="delayed">Gecikmə (Narıncı)</option>
                    <option value="paused">Dayandırılıb (Qırmızı)</option>
                </select>
            </div>
            <div class="form-buttons">
                <button type="button" class="btn btn-red" id="cancelStatusUpdate" style="display: none;">Ləğv et</button>
                <button type="submit" class="btn btn-green" id="saveStatusBtn">Yeni Status Əlavə Et</button>
            </div>
        </form>
      </div>
      <div class="section">
        <h2 style="margin:0;">Ümumi Elan Göndər</h2>
        <textarea id="announcement-textarea" placeholder="Bütün istifadəçilərə göndəriləcək mesajı bura yazın..."></textarea>
        <button id="sendAnnouncementBtn" class="btn btn-purple">Elanı Göndər</button>
        <div id="past-announcements-list"></div>
      </div>
            <div class="section">
        <h2 style="margin:0;">Dəstək Mərkəzi</h2>
        <div id="support-center">
            <div id="chat-list-container"></div>
            <div id="chat-view-container">
                <div id="chat-placeholder">Söhbətə baxmaq üçün siyahıdan bir istifadəçi seçin</div>
                <div id="chat-view" style="display:none; height:100%; flex-direction:column; display:flex;">
                    <div id="chat-view-header"></div>
                    <div id="messages-container"></div>
                    <div id="reply-area">
                        <input type="text" id="reply-input" placeholder="Cavabınızı yazın..."><button id="send-reply-btn">Göndər</button>
                    </div>
                </div>
            </div>
        </div>
      </div>
      <div class="section">
        <h2 style="margin:0;">Pul Çıxarma Sorğuları</h2>
        <table id="withdrawalsTable">
            <thead><tr><th>Email</th><th>Ad/Soyad</th><th>Kart</th><th>Məbləğ</th><th>Tarix</th><th>Status</th><th>Əməliyyat</th></tr></thead>
            <tbody><tr class="no-data-row"><td colspan="7" class="no-data">Heç bir sorğu yoxdur.</td></tr></tbody>
        </table>
      </div>
            <div class="section">
          <h2 style="margin:0;">İstifadəçilər & Balans</h2>
          <input type="search" id="userSearchInput" placeholder="Ada və ya emailə görə axtar...">
          <table id="userTable">
              <thead><tr><th>Ad</th><th>Email</th><th>Balans (AZN)</th><th>Əməliyyatlar</th></tr></thead>
                <tbody><tr class="no-data-row"><td colspan="4" class="no-data">İstifadəçi yoxdur.</td></tr></tbody>
            </table>
        </div>
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyC4sGTK_P4KperVswrxxmt69H5cocsgnNw", authDomain: "niceuc-e5986.firebaseapp.com", databaseURL: "https://niceuc-e5986-default-rtdb.firebaseio.com", projectId: "niceuc-e5986", appId: "1:242221260650:web:d140153a2167c4738dcf13" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentChatUid = null;
    let messagesListener = null;
    let masterUserList = [];
    
    window.onload = function() { loadAllData(); };

    function loadAllData() {
        loadDashboardStats();
        loadSystemStatuses();
        loadAnnouncements();
        loadSupportChats();
        loadWithdrawals();
        loadUsersAndBalances();
        initializeMoneyRainPanel();
    }
    document.getElementById('sendAnnouncementBtn').addEventListener('click', sendAnnouncement);
    function sendAnnouncement() {
        const text = document.getElementById('announcement-textarea').value.trim();
        if (!text) { alert("Elan mətni boş ola bilməz."); return; }
        const announcementData = { text, senderName: "Admin", createdAt: firebase.database.ServerValue.TIMESTAMP };
        db.ref('announcements').push(announcementData)
            .then(() => { alert("Elan uğurla göndərildi."); document.getElementById('announcement-textarea').value = ''; })
            .catch(error => alert("Xəta: " + error.message));
    }
    function loadAnnouncements() {
        const listContainer = document.getElementById('past-announcements-list');
        db.ref('announcements').orderByChild('createdAt').limitToLast(10).on('value', snapshot => {
            listContainer.innerHTML = '';
            if(!snapshot.exists()) { listContainer.innerHTML = '<p class="no-data">Hələ heç bir elan göndərilməyib.</p>'; return; }
            let announcements = [];
            snapshot.forEach(child => { announcements.push({key: child.key, ...child.val()}); });
            announcements.reverse().forEach(ann => {
                const item = document.createElement('div');
                item.className = 'past-announcement-item';
                item.innerHTML = `<div><p>${ann.text}</p><div class="meta">${new Date(ann.createdAt).toLocaleString()}</div></div><button class="btn btn-dark-red" onclick="deleteAnnouncement('${ann.key}')">Sil</button>`;
                listContainer.appendChild(item);
            });
        });
    }
    function deleteAnnouncement(key) { if(confirm("Bu elanı silmək istədiyinizə əminsiniz?")){ db.ref('announcements/' + key).remove(); } }
    function loadDashboardStats() {
        db.ref('users').on('value', snapshot => document.getElementById('stat-total-users').textContent = snapshot.numChildren());
        db.ref('balances').on('value', snapshot => { let totalBalance = 0; snapshot.forEach(child => { totalBalance += child.val().amount || 0; }); document.getElementById('stat-total-balance').textContent = totalBalance.toFixed(2); });
        db.ref('withdrawals').orderByChild('status').equalTo('pending').on('value', snapshot => {
            let pendingCount = 0;
            let pendingAmount = 0;
            snapshot.forEach(child => {
                if(!child.val().isArchived) {
                    pendingCount++;
                    pendingAmount += child.val().requestData.amount || 0;
                }
            });
            document.getElementById('stat-pending-reqs').textContent = pendingCount;
            document.getElementById('stat-pending-amount').textContent = pendingAmount.toFixed(2);
        });
        db.ref('support_chats').orderByChild('new_message_for_admin').equalTo(true).on('value', snapshot => document.getElementById('stat-unread-msgs').textContent = snapshot.numChildren());
    }
    
    // --- YENİLƏNMİŞ FUNKSİYA: İSTİFADƏÇİYƏ BİLDİRİŞ GÖNDƏRİR ---
    function addBalanceAndCreateHistory(userId, amountToAdd) {
        const amount = parseFloat(amountToAdd);
        if (!userId || isNaN(amount) || amount <= 0) return Promise.reject(new Error("Düzgün məbləğ daxil edilməyib."));
        
        const newDepositKey = db.ref('deposits').push().key;
        const newNotificationKey = db.ref(`users/${userId}/notifications`).push().key;
        
        const updates = {};
        updates[`/deposits/${newDepositKey}`] = { uid: userId, amount: amount, createdAt: firebase.database.ServerValue.TIMESTAMP, description: "Admin tərəfindən balans artımı" };
        updates[`/balances/${userId}/amount`] = firebase.database.ServerValue.increment(amount);
        updates[`/users/${userId}/notifications/${newNotificationKey}`] = {
            message: `${amount.toFixed(2)} AZN balansınıza əlavə edildi.`,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            seen: false
        };
        
        return db.ref().update(updates);
    }
      async function updateRequestStatus(key, newStatus) { if (!confirm(`Bu sorğunu "${newStatus === 'approved' ? 'Onayla' : 'Rədd et'}"?`)) return; if (newStatus === 'approved') { db.ref('withdrawals/' + key).update({ status: newStatus }).then(() => alert("Sorğu təsdiqləndi.")).catch(error => alert("Xəta: " + error.message)); } else if (newStatus === 'rejected') { const withdrawalRef = db.ref('withdrawals/' + key); try { const snapshot = await withdrawalRef.once('value'); const requestData = snapshot.val(); if (requestData?.status !== 'pending') { alert("Bu sorğu artıq emal edilib."); return; } const amountToRefund = requestData.requestData.amount; const userId = requestData.uid; await db.ref('balances/' + userId + '/amount').set(firebase.database.ServerValue.increment(amountToRefund)); await withdrawalRef.update({ status: newStatus }); alert(`Sorğu rədd edildi və ${amountToRefund.toFixed(2)} AZN istifadəçiyə geri qaytarıldı.`); } catch (error) { alert("Xəta: " + error.message); } } }
    function loadSupportChats() { const chatListContainer = document.getElementById('chat-list-container'); db.ref('support_chats').orderByChild('last_updated').on('value', snapshot => { chatListContainer.innerHTML = ''; if (!snapshot.exists()) { chatListContainer.innerHTML = '<p class="no-data">Heç bir söhbət yoxdur.</p>'; return; } let chats = []; snapshot.forEach(child => chats.push({ uid: child.key, ...child.val() })); chats.reverse().forEach(chatData => { const item = document.createElement('div'); item.className = 'chat-list-item'; if (chatData.uid === currentChatUid) item.classList.add('active'); item.innerHTML = `<span>${chatData.user_email||'Naməlum'}</span> ${chatData.new_message_for_admin ? '<div class="new-message-indicator"></div>' : ''}`; item.onclick = () => openChat(chatData.uid, chatData.user_email); chatListContainer.appendChild(item); }); }); document.getElementById('send-reply-btn').onclick = sendAdminReply; document.getElementById('reply-input').onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendAdminReply(); } }; }
    function openChat(uid, userEmail) { currentChatUid = uid; document.querySelectorAll('.chat-list-item').forEach(el => el.classList.remove('active')); [...document.querySelectorAll('.chat-list-item')].find(el => el.textContent.includes(userEmail))?.classList.add('active'); document.getElementById('chat-placeholder').style.display = 'none'; document.getElementById('chat-view').style.display = 'flex'; document.getElementById('chat-view-header').textContent = `Söhbət: ${userEmail}`; const messagesContainer = document.getElementById('messages-container'); messagesContainer.innerHTML = ''; if (messagesListener) messagesListener.off(); db.ref(`support_chats/${uid}`).update({ new_message_for_admin: false }); messagesListener = db.ref(`support_chats/${uid}/messages`).limitToLast(100).on('child_added', msgSnapshot => { const msg = msgSnapshot.val(); const msgDiv = document.createElement('div'); msgDiv.className = `message ${msg.sender === 'admin' ? 'admin' : 'user'}`; msgDiv.textContent = msg.text; messagesContainer.appendChild(msgDiv); messagesContainer.scrollTop = messagesContainer.scrollHeight; }); }
    function sendAdminReply() { const input = document.getElementById('reply-input'); const text = input.value.trim(); if (text === '' || !currentChatUid) return; const messageData = { text: text, sender: 'admin', timestamp: firebase.database.ServerValue.TIMESTAMP }; db.ref(`support_chats/${currentChatUid}/messages`).push(messageData); db.ref(`support_chats/${currentChatUid}`).update({ last_message: text, last_updated: firebase.database.ServerValue.TIMESTAMP, new_message_for_admin: false, new_message_for_user_count: firebase.database.ServerValue.increment(1) }); input.value = ''; }
    function archiveRequest(key) { if (confirm("Bu sorğunu arxivləşdirmək istəyirsiniz?")) db.ref('withdrawals/' + key).update({ isArchived: true }); }
    function deleteUser(uid, email) { if(confirm(`'${email}' istifadəçisini və ona aid bütün məlumatları sil? Bu əməliyyat geri qaytarılmazdır.`)) { const updates = {}; updates[`/users/${uid}`] = null; updates[`/balances/${uid}`] = null; updates[`/support_chats/${uid}`] = null; db.ref().update(updates); }}
    async function applyBalanceChange(uid) { const inputElement = document.getElementById(`balance-input-${uid}`); const inputValue = inputElement.value.trim().replace(',', '.'); if (inputValue === '') return; const changeValue = parseFloat(inputValue); if (isNaN(changeValue)) return alert("Düzgün rəqəm daxil edin."); try { if (inputValue.startsWith('+')) { const amountAdded = changeValue; if (confirm(`Balansa ${amountAdded.toFixed(2)} AZN əlavə edilsin?`)) { await addBalanceAndCreateHistory(uid, amountAdded); alert("Balans artırıldı və istifadəçiyə bildiriş göndərildi!"); inputElement.value = ''; } } else { const newBalance = changeValue; if (confirm(`Balansı ${newBalance.toFixed(2)} AZN olaraq təyin et? (Tarixçəyə yazılmayacaq)`)) { await db.ref('balances/' + uid).set({ amount: newBalance }); alert("Balans yeniləndi!"); inputElement.value = ''; } } } catch (error) { alert("Xəta: " + error.message); } }
    function loadWithdrawals() { const withdrawalsTableBody = document.getElementById('withdrawalsTable').querySelector('tbody'); db.ref('withdrawals').on('value', (snapshot) => { withdrawalsTableBody.innerHTML = ''; if (!snapshot.exists()) { withdrawalsTableBody.innerHTML = '<tr class="no-data-row"><td colspan="7">Heç bir sorğu yoxdur.</td></tr>'; return; } let requests = []; snapshot.forEach(child => requests.push({ key: child.key, ...child.val() })); const visibleRequests = requests.filter(req => !req.isArchived).sort((a,b) => (a.status === 'pending' ? -1 : 1) - (b.status === 'pending' ? -1 : 1) || b.createdAt - a.createdAt); if (visibleRequests.length === 0) { withdrawalsTableBody.innerHTML = '<tr class="no-data-row"><td colspan="7">Aktiv sorğu yoxdur.</td></tr>'; return; } visibleRequests.forEach(data => { const reqData = data.requestData; const tr = document.createElement('tr'); const statusMap = {'approved':'Onaylandı', 'rejected':'Rədd edildi', 'pending':'Gözləmədə'}; const actionButtons = data.status === 'pending' ? `<button class="btn btn-green" onclick="updateRequestStatus('${data.key}', 'approved')">Onayla</button><button class="btn btn-red" onclick="updateRequestStatus('${data.key}', 'rejected')">Rədd et</button>` : `<button class="btn btn-dark-red" onclick="archiveRequest('${data.key}')">Arxivlə</button>`; tr.innerHTML = `<td data-label="Email">${data.userEmail}</td><td data-label="Ad/Soyad">${reqData.name} ${reqData.surname}</td><td data-label="Kart">${reqData.cardNumber}</td><td data-label="Məbləğ"><b>${parseFloat(reqData.amount).toFixed(2)} AZN</b></td><td data-label="Tarix">${new Date(data.createdAt).toLocaleString()}</td><td data-label="Status"><span class="status status-${data.status}">${statusMap[data.status]}</span></td><td data-label="Əməliyyat"><div class="actions-cell">${actionButtons}</div></td>`; withdrawalsTableBody.appendChild(tr); }); }); }
    function displayUsers(userList) { const userTableBody = document.getElementById('userTable').querySelector('tbody'); userTableBody.innerHTML = ''; if (userList.length === 0) { userTableBody.innerHTML = '<tr class="no-data-row"><td colspan="4">İstifadəçi tapılmadı.</td></tr>'; return; } userList.forEach(userData => { const tr = document.createElement('tr'); tr.innerHTML = `<td data-label="Ad">${userData.displayName||'Adsız'}</td><td data-label="Email">${userData.email}</td><td data-label="Balans (AZN)"><b>${parseFloat(userData.balance).toFixed(2)} AZN</b></td><td data-label="Əməliyyatlar"><div class="actions-cell"><input type="text" id="balance-input-${userData.uid}" placeholder="+50, 200" class="balance-input"><button class="btn btn-blue" onclick="applyBalanceChange('${userData.uid}')">Tətbiq et</button><button class="btn btn-dark-red" onclick="deleteUser('${userData.uid}', '${userData.email}')">Sil</button></div></td>`; userTableBody.appendChild(tr); }); }
    function loadUsersAndBalances() { db.ref('users').on('value', (userSnapshot) => { db.ref('balances').on('value', (balanceSnapshot) => { masterUserList = []; if (!userSnapshot.exists()) { displayUsers([]); return; } const allBalances = balanceSnapshot.val() || {}; userSnapshot.forEach(childSnapshot => { const uid = childSnapshot.key; masterUserList.push({ uid, ...childSnapshot.val(), balance: allBalances[uid]?.amount || 0 }); }); document.getElementById('userSearchInput').dispatchEvent(new Event('input')); }); }); }
    document.getElementById('userSearchInput').addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); if (!searchTerm) { displayUsers(masterUserList); return; } displayUsers(masterUserList.filter(user => user.displayName?.toLowerCase().includes(searchTerm) || user.email?.toLowerCase().includes(searchTerm))); });
    function loadSystemStatuses() { const tableBody = document.getElementById('statusManagementTable').querySelector('tbody'); db.ref('system_status').on('value', (snapshot) => { tableBody.innerHTML = ''; if (!snapshot.exists()) { tableBody.innerHTML = '<tr class="no-data-row"><td colspan="5">Status yoxdur.</td></tr>'; return; } let statuses = []; snapshot.forEach(child => statuses.push({ key: child.key, ...child.val() })); statuses.sort((a, b) => a.order - b.order).forEach(data => { const tr = document.createElement('tr'); tr.innerHTML = `<td data-label="Sıra">${data.order}</td><td data-label="Başlıq">${data.label}</td><td data-label="Açıqlama">${data.status_text}</td><td data-label="Vəziyyət">${data.state}</td><td data-label="Əməliyyatlar"><div class="actions-cell"><button class="btn btn-blue" onclick='editStatus("${data.key}", ${JSON.stringify(JSON.stringify(data))})'>Redaktə</button><button class="btn btn-red" onclick="deleteStatus('${data.key}')">Sil</button></div></td>`; tableBody.appendChild(tr); }); }); }
    function resetStatusForm() { document.getElementById('statusForm').reset(); document.getElementById('statusKey').value = ''; document.getElementById('saveStatusBtn').textContent = 'Yeni Status Əlavə Et'; document.getElementById('cancelStatusUpdate').style.display = 'none'; }
    function editStatus(key, jsonData) { const data = JSON.parse(jsonData); document.getElementById('statusKey').value = key; document.getElementById('statusLabel').value = data.label; document.getElementById('statusText').value = data.status_text; document.getElementById('statusOrder').value = data.order; document.getElementById('statusState').value = data.state; document.getElementById('saveStatusBtn').textContent = 'Yenilə'; document.getElementById('cancelStatusUpdate').style.display = 'inline-block'; window.scrollTo(0, document.getElementById('statusForm').offsetTop); }
    function deleteStatus(key) { if (confirm("Bu statusu silmək istəyirsiniz?")) db.ref('system_status/' + key).remove(); }
    document.getElementById('statusForm').addEventListener('submit', function(e) { e.preventDefault(); const key = document.getElementById('statusKey').value; const statusData = { label: document.getElementById('statusLabel').value, status_text: document.getElementById('statusText').value, order: parseInt(document.getElementById('statusOrder').value), state: document.getElementById('statusState').value }; const promise = key ? db.ref('system_status/' + key).update(statusData) : db.ref('system_status').push(statusData); promise.then(() => { alert(key ? "Status yeniləndi." : "Status əlavə edildi."); resetStatusForm(); }).catch(error => alert("Xəta: " + error.message)); });
    document.getElementById('cancelStatusUpdate').addEventListener('click', resetStatusForm);
    function initializeMoneyRainPanel() { const moneyRainRef = db.ref('moneyRainEvent'); const statusEl = document.getElementById('moneyRainStatus'); const startBtn = document.getElementById('startMoneyRainBtn'); const stopBtn = document.getElementById('stopMoneyRainBtn'); moneyRainRef.on('value', (snapshot) => { const status = snapshot.val()?.status || 'idle'; statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1); statusEl.className = 'status-display ' + status; startBtn.disabled = !(status === 'idle' || status === 'finished'); stopBtn.disabled = (status === 'idle' || status === 'finished'); }); startBtn.addEventListener('click', startMoneyRain); stopBtn.addEventListener('click', stopMoneyRain); }
    function startMoneyRain() { const amount = parseFloat(document.getElementById('moneyRainAmount').value); const duration = parseInt(document.getElementById('moneyRainDuration').value, 10); if (isNaN(amount) || amount <= 0 || isNaN(duration) || duration < 10) return alert("Düzgün məbləğ və müddət daxil edin (min 10 san)."); if (!confirm(`${amount.toFixed(2)} AZN məbləğində Para Yağışını başlatmaq istəyirsiniz?`)) return; const eventData = { status: 'pending', totalAmount: amount, startTime: Date.now() + 30000, duration: duration * 1000, participants: null, leaderboard: null }; setTimeout(() => db.ref('moneyRainEvent/status').set('active'), 30000); setTimeout(() => { db.ref('moneyRainEvent').once('value', snapshot => { if(snapshot.val()?.status === 'active') calculateResultsFromAdmin(snapshot.val()); }); }, 30000 + (duration * 1000) + 1000); db.ref('moneyRainEvent').set(eventData).catch(error => alert("Xəta: " + error.message)); }
    function stopMoneyRain() { if (confirm("Para Yağışını dayandırmaq istəyirsiniz?")) db.ref('moneyRainEvent').update({ status: 'idle' }); }
    function calculateResultsFromAdmin(eventData) { const participants = eventData.participants || {}; const totalAmount = eventData.totalAmount; let totalScore = Object.values(participants).reduce((sum, p) => sum + p.score, 0); if (totalScore === 0) { db.ref('moneyRainEvent/status').set('finished'); setTimeout(() => db.ref('moneyRainEvent').update({ status: 'idle' }), 15000); return; } const leaderboard = {}; const allUpdates = {}; Object.entries(participants).forEach(([uid, participant]) => { const reward = parseFloat(((participant.score / totalScore) * totalAmount).toFixed(2)); if (reward > 0) { leaderboard[uid] = { displayName: participant.displayName, score: participant.score, reward }; allUpdates[`/balances/${uid}/amount`] = firebase.database.ServerValue.increment(reward); const newDepositKey = db.ref('deposits').push().key; allUpdates[`/deposits/${newDepositKey}`] = { uid, amount: reward, createdAt: firebase.database.ServerValue.TIMESTAMP, type: 'deposit', description: 'Para Yağışı Mükafatı' }; } }); allUpdates['/moneyRainEvent/leaderboard'] = leaderboard; allUpdates['/moneyRainEvent/status'] = 'finished'; db.ref().update(allUpdates); setTimeout(() => db.ref('moneyRainEvent').update({ status: 'idle' }), 30000); }
</script>
</body>
</html>
