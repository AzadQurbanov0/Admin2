<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #1a2c50; }
        .tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border-radius: 6px 6px 0 0; }
        .tab.active { background-color: #1a2c50; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        .form-section h3 { margin-top: 0; }
        input, select, button { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .btn-approve { background-color: #28a745; }
        .btn-reject { background-color: #dc3545; }
    </style>
</head>
<body>

    <div class="container">
        <div id="admin-panel">
            <h1>İdarəetmə Paneli</h1>
            
            <div class="tabs">
                <div class="tab active" onclick="openTab('mining')">Minik Kartları</div>
                <div class="tab" onclick="openTab('tasks')">Tapşırıqlar</div>
            </div>

            <div id="mining" class="tab-content active">
                <h2>Minik Kartları İdarəetmə</h2>

                <div class="form-section">
                    <h3>Yeni Minik Kartı Yarat</h3>
                    <input type="text" id="cardId" placeholder="Kart ID (məs: gold_miner)">
                    <input type="text" id="cardName" placeholder="Kartın Adı (məs: Qızıl Mədənçisi)">
                    <input type="text" id="cardImageUrl" placeholder="Kartın Şəkil URL-i">
                    <button onclick="createMiningCard()">Kart Yarat</button>
                </div>

                <div class="form-section">
                    <h3>Kart Səviyyə Parametrləri</h3>
                    <p>Mövcud kart üçün səviyyə, qiymət və saat karını daxil edin.</p>
                    <input type="text" id="ruleCardId" placeholder="Səviyyə əlavə ediləcək Kart ID">
                    <input type="number" id="cardLevel" placeholder="Səviyyə (məs: 1)">
                    <input type="number" id="levelCost" placeholder="Bu səviyyəyə keçid qiyməti (Coin)">
                    <input type="number" id="levelRate" placeholder="Bu səviyyənin verdiyi Saat Karı">
                    <button onclick="setCardLevelRule()">Səviyyəni Təyin Et</button>
                </div>
            </div>

                        <div id="tasks" class="tab-content">
                <h2>Tapşırıqlar İdarəetmə</h2>

                <div class="form-section">
                    <h3>Yeni Tapşırıq Yarat</h3>
                    <input type="text" id="taskTitle" placeholder="Tapşırıq Başlığı">
                    <input type="text" id="taskDesc" placeholder="Tapşırıq Açıqlaması">
                    <input type="text" id="taskLink" placeholder="Tapşırıq Linki (URL)">
                    <select id="taskRewardType">
                        <option value="coin">Coin</option>
                        <option value="gems">Gems</option>
                        <option value="xp">XP</option>
                    </select>
                    <input type="number" id="taskRewardAmount" placeholder="Mükafat Miqdarı">
                    <button onclick="createTask()">Tapşırıq Yarat</button>
                </div>

                <div class="form-section">
                    <h3>Gözləyən Tapşırıqlar</h3>
                    <table id="submissionsTable">
                        <thead>
                            <tr>
                                <th>İstifadəçi ID</th>
                                <th>Tapşırıq ID</th>
                                <th>Tarix</th>
                                <th>Əməliyyat</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC4sGTK_P4KperVswrxxmt69H5cocsgnNw", authDomain: "niceuc-e5986.firebaseapp.com", databaseURL: "https://niceuc-e5986-default-rtdb.firebaseio.com", projectId: "niceuc-e5986", appId: "1:242221260650:web:d140153a2167c4738dcf13" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Səhifə yüklənəndə tapşırıqları yüklə
        window.onload = function() {
            loadSubmissions();
        };

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- Minik Kart Funksiyaları ---
        function createMiningCard() {
            const cardId = document.getElementById('cardId').value.trim();
            const name = document.getElementById('cardName').value.trim();
            const imageUrl = document.getElementById('cardImageUrl').value.trim();
            if (!cardId || !name || !imageUrl) return alert('Bütün xanaları doldurun.');

            db.ref('mining_cards/' + cardId).set({ name, imageUrl })
                .then(() => alert(`'${name}' kartı uğurla yaradıldı!`))
                .catch(err => alert('Xəta: ' + err.message));
        }

        function setCardLevelRule() {
            const cardId = document.getElementById('ruleCardId').value.trim();
            const level = document.getElementById('cardLevel').value;
            const cost = parseInt(document.getElementById('levelCost').value);
            const rate = parseInt(document.getElementById('levelRate').value);
            if (!cardId || !level || isNaN(cost) || isNaN(rate)) return alert('Bütün xanaları düzgün doldurun.');

            db.ref(`card_level_rules/${cardId}/${level}`).set({ cost: cost, hourly_rate_provided: rate })
                .then(() => alert(`${cardId} kartının ${level}-ci səviyyəsi təyin edildi!`))
                .catch(err => alert('Xəta: ' + err.message));
        }

        // --- Tapşırıq Funksiyaları ---
        function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDesc').value.trim();
            const link = document.getElementById('taskLink').value.trim();
            const reward_type = document.getElementById('taskRewardType').value;
            const reward_amount = parseInt(document.getElementById('taskRewardAmount').value);
            if (!title || !description || !link || isNaN(reward_amount)) return alert('Bütün xanaları doldurun.');

            const newTaskRef = db.ref('tasks').push();
            newTaskRef.set({ title, description, link, reward_type, reward_amount })
                .then(() => alert('Tapşırıq uğurla yaradıldı!'))
                .catch(err => alert('Xəta: ' + err.message));
        }

        function loadSubmissions() {
            const submissionsRef = db.ref('task_submissions').orderByChild('status').equalTo('pending');
            submissionsRef.on('value', snapshot => {
                const tableBody = document.getElementById('submissionsTable').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = '';
                if (!snapshot.exists()) {
                    tableBody.innerHTML = '<tr><td colspan="4">Gözləyən tapşırıq yoxdur.</td></tr>';
                    return;
                }
                snapshot.forEach(userSubmissions => {
                    const uid = userSubmissions.key;
                    userSubmissions.forEach(taskSubmission => {
                        if (taskSubmission.val().status === 'pending') {
                            const taskId = taskSubmission.key;
                            const submissionData = taskSubmission.val();
                            const date = new Date(submissionData.submittedAt).toLocaleString('az-AZ');
                            const row = tableBody.insertRow();
                            row.innerHTML = `
                                <td>${uid.substring(0, 10)}...</td>
                                <td>${taskId}</td>
                                <td>${date}</td>
                                <td>
                                    <button class="btn-approve" onclick="approveSubmission('${uid}', '${taskId}')">Təsdiqlə</button>
                                    <button class="btn-reject" onclick="rejectSubmission('${uid}', '${taskId}')">Rədd Et</button>
                                </td>
                            `;
                        }
                    });
                });
            });
        }
        
        async function approveSubmission(uid, taskId) {
            const taskSnapshot = await db.ref(`tasks/${taskId}`).once('value');
            if (!taskSnapshot.exists()) return alert('Tapşırıq tapılmadı.');
            
            const task = taskSnapshot.val();
            const updates = {};
            
            if (task.reward_type === 'coin') {
                updates[`/user_coins/${uid}/amount`] = firebase.database.ServerValue.increment(task.reward_amount);
            } else if (task.reward_type === 'gems') {
                updates[`/user_gems/${uid}/amount`] = firebase.database.ServerValue.increment(task.reward_amount);
            }
            
            updates[`/task_submissions/${uid}/${taskId}/status`] = 'completed';
            
            db.ref().update(updates)
                .then(() => alert(`${uid} üçün tapşırıq təsdiqləndi.`))
                .catch(err => alert('Xəta: ' + err.message));
        }

        function rejectSubmission(uid, taskId) {
            db.ref(`/task_submissions/${uid}/${taskId}/status`).set('rejected')
                .then(() => alert(`${uid} üçün tapşırıq rədd edildi.`))
                .catch(err => alert('Xəta: ' + err.message));
        }
    </script>
</body>
</html>
